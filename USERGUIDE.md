# Zoom通話録音 文字起こしシステム 利用ガイド

このガイドでは、Zoom通話録音の自動文字起こしシステムの利用方法について説明します。

## システム概要

このシステムは、Zoomphoneで録音された通話を自動的に文字起こしし、会話内容を分析・要約するものです。録音から文字起こし完了までの一連の流れが自動化されており、ユーザーはスプレッドシートで結果を確認するだけで利用できます。

**新機能:**
- **高度なエラー検知・復旧機能**: 処理失敗を自動検知し、復旧処理を実行
- **システム健全性チェック**: 定期的な品質監視とテスト機能
- **部分的失敗の検知**: 見逃されがちなエラーを後から検知・修正

## 処理の流れ

1. **録音ファイル情報の収集**
   - Zoomphoneで通話録音が完了すると、自動的に録音ファイルの情報がRecordingsシートに記録されます
   - この段階では、まだファイル本体は取得されておらず、メタデータ（録音ID、URL、タイムスタンプなど）のみが記録されます

2. **録音ファイルの取得**
   - 平日・土日祝日問わず6:00～24:00の間、30分ごとに自動実行
   - 直近2時間以内に生成され、まだ取得していない録音ファイルを対象にGoogleドライブへダウンロード
   - 取得が完了すると、Recordingsシートの`status_fetch`カラムが`PROCESSED`に更新されます

3. **文字起こし処理**
   - 平日・土日祝日問わず6:00～24:00の間、10分ごとに自動実行
   - 未処理フォルダにあるファイルを最大10ファイルまで処理（古いファイル順）
   - 文字起こしが完了すると、Recordingsシートの`status_transcription`カラムが`SUCCESS`に更新
   - 文字起こし結果はcall_recordsシートに保存されます

4. **夜間バッチ処理**
   - 24:00～6:00の間に録音されたファイルは、翌朝6:15に一括処理されます

## 処理のタイミング

| 処理内容 | スケジュール | 詳細 |
|---------|------------|------|
| 録音ファイル取得 | 6:00～24:00の間で30分ごと | 直近2時間の未処理録音を取得 |
| 文字起こし処理 | 6:00～24:00の間で10分ごと | 未処理ファイルを最大10件処理 |
| 夜間バッチ | 毎朝6:15に実行 | 前日夜から当日朝までの録音を処理 |
| **部分的失敗検知** | **毎日22:00** | **見逃されたエラーを検知・復旧** |
| **中断ファイル復旧** | **5分ごと** | **処理中断されたファイルを自動復旧** |
| **PENDING状態リセット** | **2時間ごと** | **長時間PENDING状態のファイルをリセット** |
| **エラーファイル復旧** | **4時間ごと** | **エラーフォルダのファイルを再処理** |

## 利用方法

### 1. 処理状況の確認方法

**Recordingsシート**で各録音ファイルの処理状況を確認できます：

| カラム | 説明 | 主な値 |
|-------|------|-------|
| record_id | 録音の一意識別子 | - |
| timestamp_recording | 録音が生成された時刻 | - |
| download_url | 録音ファイルのダウンロードURL | - |
| status_fetch | ファイル取得状況 | PENDING（未取得）, PROCESSED（取得済）, DOWNLOAD_ERROR（取得エラー） |
| timestamp_fetch | ファイル取得処理日時 | - |
| status_transcription | 文字起こし状況 | PENDING（未処理）, SUCCESS（成功）, ERROR（エラー）, **ERROR_DETECTED（後から検知されたエラー）**, **RETRY（復旧処理対象）** |
| timestamp_transcription | 文字起こし処理日時 | - |
| process_start | 処理開始時間 | - |
| process_end | 処理終了時間 | - |

**新しいステータスについて:**
- **ERROR_DETECTED**: 一度SUCCESSになったが、後から問題が検知されたファイル
- **RETRY**: 復旧処理の対象となっているファイル

### 2. 文字起こし結果の確認方法

**call_recordsシート**で文字起こし結果を確認できます：

| カラム | 説明 |
|-------|------|
| record_id | 録音ID（Recordingsシートと紐づく） |
| call_date | 通話日 |
| call_time | 通話時間 |
| sales_phone_number | セールス側電話番号 |
| sales_company | セールス会社名 |
| sales_person | セールス担当者名 |
| customer_phone_number | 顧客電話番号 |
| customer_company | 顧客会社名 |
| customer_name | 顧客名 |
| call_status | 通話ステータス（成約、アポ取得、拒否など） |
| reason_for_refusal | 拒否理由（該当する場合） |
| reason_for_appointment | アポイント理由（該当する場合） |
| summary | 通話の要約 |
| full_transcript | 完全な文字起こしテキスト |

## 便利な使い方

1. **フィルタリング機能を使う**
   - Recordingsシートで「データ」→「フィルタ表示」を選択
   - 各列のフィルタアイコンをクリックして、特定の状態（例：PENDING）のみを表示

2. **最新の文字起こし結果をチェック**
   - call_recordsシートで「データ」→「並べ替え範囲」→「Z→A」を選択し、最新の通話を上部に表示

3. **検索機能を使う**
   - 「編集」→「検索と置換」（Ctrl+F）で、特定の電話番号や会社名などを検索

4. **エラー状況の確認**
   - Recordingsシートで`status_transcription`列をフィルタして「ERROR」や「ERROR_DETECTED」を表示
   - 復旧処理の対象ファイルは「RETRY」ステータスで確認可能

5. **処理の進捗確認**
   - `process_start`と`process_end`の時間差で処理時間を確認
   - 長時間処理中のファイルがある場合は、自動復旧機能が作動します

6. **品質監視**
   - システムが自動的に品質チェックを実行するため、ユーザー側での特別な操作は不要
   - 問題が検知された場合は管理者に自動通知されます

## 注意事項

1. **処理のタイムラグ**
   - 録音完了から文字起こし結果の表示まで、最大で1～2時間程度かかる場合があります
   - 特に多数の録音が同時に生成された場合は、処理に時間がかかることがあります

2. **文字起こし精度**
   - 通話品質や背景ノイズによっては、文字起こしの精度が低下する場合があります
   - 専門用語や固有名詞は正確に認識されないことがあります

3. **エラーが発生した場合**
   - 文字起こしでエラーが発生した場合、call_recordsシートには保存されません
   - Recordingsシートの`status_transcription`カラムが`ERROR`となり、詳細エラーメッセージが表示されます
   - **新機能**: システムが自動的にエラーを検知し、復旧処理を実行します

4. **自動復旧機能について**
   - **部分的失敗の検知**: 毎日22:00に、見逃されたエラーを自動検知します
   - **自動復旧処理**: エラーファイルは定期的に自動復旧が試行されます
   - **処理中断の対応**: システム障害等で中断されたファイルは5分ごとに自動復旧されます
   - **長時間PENDING対応**: 2時間以上PENDING状態のファイルは自動的にリセットされます

5. **手動での処理について**
   - このシステムは完全自動化されており、基本的に手動操作は不要です
   - もし特定のファイルを優先して処理したい場合は、システム管理者にお問い合わせください
   - **システム健全性**: 定期的にシステムの品質チェックが実行され、問題があれば自動的に管理者に通知されます

6. **深夜帯の録音**
   - 24:00～6:00の間に録音されたファイルは翌朝まで処理されないため、結果の確認は翌朝以降となります

7. **システムの信頼性向上**
   - **高度なエラー検知**: OpenAI APIのクォータ制限やレスポンスエラーを即座に検知
   - **見逃し防止**: 一度SUCCESSになったファイルでも、実際にはエラーが含まれている場合を検知
   - **自動通知**: 問題が検知された場合、管理者に自動でメール通知が送信されます

## ヘルプとサポート

システムの動作に問題がある場合や、ご質問がある場合は、システム管理者までお問い合わせください。 